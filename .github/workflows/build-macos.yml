name: Build macOS DMG

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      upload_manifest:
        description: 'ÊòØÂê¶‰∏ä‰º†Âà∞ manifest'
        required: false
        default: true
        type: boolean
      force_update:
        description: 'ÊòØÂê¶Âº∫Âà∂Êõ¥Êñ∞'
        required: false
        default: false
        type: boolean

jobs:
  build:
    runs-on: macos-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      artifact_name: ${{ steps.version.outputs.artifact_name }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.2'
          channel: 'stable'
          cache: true

      - name: Get version from pubspec.yaml
        id: version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | cut -d'+' -f1)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "artifact_name=loveace-macos-$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Version: $VERSION"

      - name: Get dependencies
        run: flutter pub get

      - name: Disable code signing in Xcode project
        run: |
          # ‰øÆÊîπ project.pbxproj Á¶ÅÁî®‰ª£Á†ÅÁ≠æÂêç
          sed -i '' 's/CODE_SIGN_STYLE = Automatic/CODE_SIGN_STYLE = Manual/g' macos/Runner.xcodeproj/project.pbxproj
          sed -i '' 's/"CODE_SIGN_IDENTITY\[sdk=macosx\*\]" = "Apple Development"/"CODE_SIGN_IDENTITY[sdk=macosx*]" = "-"/g' macos/Runner.xcodeproj/project.pbxproj
          sed -i '' 's/DEVELOPMENT_TEAM = [^;]*;/DEVELOPMENT_TEAM = "";/g' macos/Runner.xcodeproj/project.pbxproj
          sed -i '' 's/PROVISIONING_PROFILE_SPECIFIER = "[^"]*"/PROVISIONING_PROFILE_SPECIFIER = ""/g' macos/Runner.xcodeproj/project.pbxproj
          echo "‚úÖ Code signing disabled"

      - name: Build macOS
        run: flutter build macos --release

      - name: Ad-hoc code sign
        run: |
          APP_PATH="build/macos/Build/Products/Release/loveace.app"
          
          # ÈÄíÂΩíÁ≠æÂêçÊâÄÊúâÊ°ÜÊû∂ÂíåÂä®ÊÄÅÂ∫ì
          find "$APP_PATH" -name "*.framework" -o -name "*.dylib" | while read -r item; do
            codesign --force --deep --sign - "$item" || true
          done
          
          # Á≠æÂêç‰∏ªÂ∫îÁî®
          codesign --force --deep --sign - "$APP_PATH"
          
          echo "‚úÖ Ad-hoc code signing completed"

      - name: Install create-dmg
        run: brew install create-dmg

      - name: Create DMG
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          APP_PATH="build/macos/Build/Products/Release/loveace.app"
          DMG_PATH="build/macos/loveace-$VERSION.dmg"
          
          # ÂàõÂª∫ DMG
          create-dmg \
            --volname "ÂΩ©Â∏¶Â∞èÂ∑•ÂÖ∑" \
            --volicon "$APP_PATH/Contents/Resources/AppIcon.icns" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "loveace.app" 150 185 \
            --hide-extension "loveace.app" \
            --app-drop-link 450 185 \
            "$DMG_PATH" \
            "$APP_PATH" || true
          
          # Â¶ÇÊûú create-dmg Â§±Ë¥•Ôºå‰ΩøÁî®ÁÆÄÂçïÊñπÂºèÂàõÂª∫
          if [ ! -f "$DMG_PATH" ]; then
            echo "‚ö†Ô∏è create-dmg failed, using hdiutil..."
            hdiutil create -volname "ÂΩ©Â∏¶Â∞èÂ∑•ÂÖ∑" -srcfolder "$APP_PATH" -ov -format UDZO "$DMG_PATH"
          fi
          
          echo "‚úÖ DMG created: $DMG_PATH"

      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.version.outputs.artifact_name }}
          path: build/macos/loveace-${{ steps.version.outputs.version }}.dmg

      - name: Upload to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: build/macos/loveace-${{ steps.version.outputs.version }}.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  upload-manifest:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'release' || github.event.inputs.upload_manifest == 'true'
    environment: S3
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download DMG artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.artifact_name }}
          path: ./dmg

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install CLI dependencies
        run: |
          pip install uv
          cd utils && uv sync

      - name: Read changelog
        id: changelog
        run: |
          VERSION="${{ needs.build.outputs.version }}"
          CHANGELOG=""
          
          if [[ -f "CHANGELOG.txt" ]]; then
            FOUND=false
            while IFS= read -r line || [[ -n "$line" ]]; do
              if [[ "$FOUND" == "true" ]]; then
                if [[ -z "$line" ]] || [[ "$line" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
                  break
                fi
                if [[ -n "$CHANGELOG" ]]; then
                  CHANGELOG="$CHANGELOG"$'\n'"$line"
                else
                  CHANGELOG="$line"
                fi
              fi
              if [[ "$line" == "$VERSION" ]]; then
                FOUND=true
              fi
            done < CHANGELOG.txt
          fi
          
          {
            echo "changelog<<EOF"
            echo "$CHANGELOG"
            echo "EOF"
          } >> $GITHUB_OUTPUT
          echo "üìù Changelog for $VERSION:"
          echo "$CHANGELOG"

      - name: Upload to manifest
        env:
          S3_ENDPOINT: ${{ secrets.S3_ENDPOINT }}
          S3_ACCESS_KEY: ${{ secrets.S3_ACCESS_KEY }}
          S3_SECRET_KEY: ${{ secrets.S3_SECRET_KEY }}
          S3_BUCKET: ${{ secrets.S3_BUCKET }}
          S3_REGION: ${{ secrets.S3_REGION }}
          CDN_BASE_URL: ${{ secrets.CDN_BASE_URL }}
          CHANGELOG: ${{ steps.changelog.outputs.changelog }}
        run: |
          FORCE_FLAG=""
          if [[ "${{ github.event.inputs.force_update }}" == "true" ]]; then
            FORCE_FLAG="--force"
          fi
          
          cd utils
          
          if [[ -n "$CHANGELOG" ]]; then
            uv run python cli.py release \
              --version "${{ needs.build.outputs.version }}" \
              --platform macos \
              --file "../dmg/loveace-${{ needs.build.outputs.version }}.dmg" \
              --changelog "$CHANGELOG" \
              $FORCE_FLAG
          else
            uv run python cli.py release \
              --version "${{ needs.build.outputs.version }}" \
              --platform macos \
              --file "../dmg/loveace-${{ needs.build.outputs.version }}.dmg" \
              $FORCE_FLAG
          fi
